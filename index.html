<!DOCTYPE html>
<html lang="ja">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>CSVファイル表示</title>
</head>
<body>
 <h1>CSVファイルの内容</h1>
 <div class="event">
 <p>曜日(イベント)を選択</p>
 <div class="event-radio">
  <input type="radio" id="radio1" name="radioButton" value="1">
  <label for="radio1">水曜・日曜(等倍)</label>
 </div>
 <div class="event-radio">
  <input type="radio" id="radio2" name="radioButton" value="1.5">
  <label for="radio2">月曜・木曜・金曜(1.5倍)</label>
 </div>
 <div class="event-radio">
  <input type="radio" id="radio3" name="radioButton" value="2.5">
  <label for="radio3">火曜・土曜(2.5倍)</label>
 </div>
 <div class="event-radio">
  <input type="radio" id="radio4" name="radioButton" value="4">
  <label for="radio4">4倍イベント</label>
 </div>
 </div>

 <div class="multi">
 <p class="subject">倍率指定</p>
 <div class="multi-check">
  <input type="checkbox" id="monthly">
  <label for="monthly">マンスリーパス効果(+15%)</label>
 </div>
 <div class="multi-check">
  <input type="checkbox" id="passive">
  <label for="passive">[ごめんねFingers crossed]梅澤美波<br>[まあいいか？]秋元真夏 どちらかを所持(+30%)</label>
 </div>
 <div class="multi-check">
  <input type="text" class="textbox" id="memo" inputmode="decimal">
  <label for="memo">％：メンバーノギメモ効果</label>
 </div>
	 <div class="range-slider">
	 <label for="rangeSlider" class="range-text">上振れ補正</label>	
  <input type="range" id="rangeSlider" min="0" max="5" step="0.5" value="0" oninput="updateRangeValue()">
	 <span class="range-text">+</span>
  <span class="range-label" id="rangeLabel">0</span>
	 <span class="range-text">[%]</span>
 </div>
 </div>
  
 <div class="range">
 <input type="text" class="textbox" id="start" inputmode="decimal">
 <label for="start">開始行</label>
 <input type="text" class="textbox" id="end" inputmode="decimal">
 <label for="end">終了行</label>
 </div>
  
 <div class="switch">
 <input type="checkbox" id="non120">
 <label for="non120">切り替え</label>
 </div>
  
 <button id="btn-csv">開く</button>
  
 <table id="csv-table"></table>
  
 <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/1.0.5/jquery.csv.min.js"></script>
  
 <script>
$(document).ready(function() {
  // localStorageから設定値を読み込み
  const settings = JSON.parse(localStorage.getItem('user-settings')) || {};

  // 各要素に設定値を反映
  $('#radio' + settings.eventMultiplierValue).prop('checked', true);
  $('#monthly').prop('checked', settings.monthlyMultiplierValue);
  $('#passive').prop('checked', settings.passiveMultiplierValue);
  $('#memo').val(settings.memoMultiplierValue);
  $('#rangeSlider').val(settings.rangeSliderMultiplierValue);

  // ボタンクリック時の処理
  $('#btn-csv').click(function() {
    // 各入力値を取得
    const eventMultiplierValue = $('input[name="radioButton"]:checked').val();
    const monthlyMultiplierValue = $('#monthly').is(':checked');
    const passiveMultiplierValue = $('#passive').is(':checked');
    const memoMultiplierValue = parseFloat($('#memo').val());

    // NaNの場合は0に置き換える
    if (isNaN(memoMultiplierValue)) {
      memoMultiplierValue = 0;
    }

    const rangeSliderMultiplierValue = settings.rangeSliderMultiplierValue;

    // 設定値をlocalStorageに保存
    localStorage.setItem('user-settings', JSON.stringify({
      eventMultiplierValue,
      monthlyMultiplierValue,
      passiveMultiplierValue,
      memoMultiplierValue,
      rangeSliderMultiplierValue,
    }));

    // 既存の処理
    const csvFile = $('#non120').is(':checked') ? 'xp2.csv' : 'xp1.csv';
    const startRow = parseInt($('#start').val()); // 開始行
    const endRow = parseInt($('#end').val()); // 終了行

    $.ajax({
      url: csvFile,
      dataType: 'text',
      success: function(data) {
        const csvData = $.csv.toArrays(data);
        const tableElement = $('#csv-table');
        tableElement.empty(); // テーブルをクリア

        // ヘッダー行の表示
        const headerRowElement = showHeaderRow(csvData);
        tableElement.append(headerRowElement);

        // データ行の表示
        for (let i = startRow; i <= endRow; i++) {
          if (i >= csvData.length) {
            break;
          }
          const rowElement = showDataRow(csvData, i, startRow, endRow, multiplier);
          tableElement.append(rowElement);
        }
      }
    });
  });

  // ラジオボタンの値を取得
  function getRadioButtonValue() {
    const radioButtons = $('input[name="radioButton"]');
    const selectedRadioButton = radioButtons.filter(':checked');
    const value = selectedRadioButton.val();
    return value === '' ? 0 : parseFloat(value);
  }

  // マンスリーチェックボックスの値を取得
  function getMonthlyMultiplier() {
    return $('#monthly').is(':checked') ? 0.15 : 0;
  }

  // パッシブチェックボックスの値を取得
  function getPassiveMultiplier() {
    return $('#passive').is(':checked') ? 0.3 : 0;
}
// メモテキストボックスの値を取得
function getMemoMultiplier() {
return parseFloat($('#memo').val());
  }

  // レンジスライダーの値を取得
  function getRangeSliderMultiplier() {
    return settings.rangeSliderMultiplierValue;
  }

  // レンジスライダーの値更新
  $('#rangeSlider').on('input', function() {
    const value = $(this).val();
    $('#rangeLabel').text(value);
  });

  // 初期化処理
  updateRangeValue();
});

// ヘッダー行の表示
function showHeaderRow(csvData) {
  let headerRowElement = '<tr>';
  for (let j = 0; j < csvData[0].length; j++) {
    headerRowElement += '<th>' + csvData[0][j] + '</th>';
  }
  headerRowElement += '</tr>';
  return headerRowElement;
}

// データ行の表示
function showDataRow(csvData, i, startRow, endRow, multiplier) {
  if (i >= csvData.length) {
    return;
  }
  let rowElement = '<tr>';
  for (let j = 0; j < csvData[i].length; j++) {
    if (i === 0 || j === 0) {
      // ヘッダー行またはヘッダー列の場合は倍率を適用しない
      rowElement += '<td>' + csvData[i][j] + '</td>';
      continue;
    }

    // 倍率計算
    const R = getRadioButtonValue();
    const M = getMonthlyMultiplier();
    const P = getPassiveMultiplier();
    const N = memoMultiplierValue;
    const S = getRangeSliderMultiplier();
    const multiplier = R * (1 + M + P + (N / 100)) * (1 + (S / 100));

    // 数値に倍率を適用し、小数点以下を切り捨て
    const value = Math.floor(parseFloat(csvData[i][j]) * multiplier).toLocaleString('ja-JP');
    rowElement += '<td>' + value + '</td>';
  }
  rowElement += '</tr>';
  return rowElement;
}

// 初期化処理
function updateRangeValue() {
  const rangeValue = document.getElementById('rangeSlider').value;
  document.getElementById('rangeLabel').innerText = rangeValue;
}
 </script>
 <style>
 table {
  border-collapse: collapse;
  width: 50%;
  height: 50%;
 }
 th, td {
  border: 1px solid black;
  padding: 5px;
 }
 </style>
</body>
</html>
